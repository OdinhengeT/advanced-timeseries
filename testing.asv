clear all
close all
addpath('functions', 'data');
clc

%%

knots = [0,0, 0, 0, 1, 1, 1, 1];

%x = [-0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9 1, 1.1];
x = linspace(0, 1, 500);

B = cox_deBoor(x, knots,4, 0);

figure(); hold on;
for idx = 1:length(B(1,:))
    plot(x, B(:, idx))
end

%%
N = 250

x = linspace(-4, 12, N);

xs = linspace(-4.5, 12.5, 2*N);

y = -0.02*x.^3 + 0.23.*x.^2 + randn(1,N);%+ sin(3.*x) ;

[theta, knots] = smooth_spline(x, y, 0.5);

yhat = cox_deBoor(xs, knots, 4)*theta;

figure(); hold on;
scatter(x, y);
plot(xs, yhat)

%%

N = 5000;

x = linspace(-30, 30, N);

xs = linspace(-31, 31, 2*N);

y = sin(6.*x)+3*sin(x)-cos(3.*x)+0.2*x+0.01.*x.^2 + 0.3.*randn(1, N);

[theta, knots] = smooth_spline(x, y, 0.00001, 4, [-31; 31]);

yhat = cox_deBoor(xs, knots{1}, 4)*theta;

figure(); hold on;
scatter(x, y);
plot(xs, yhat)

% B = cox_deBoor(xs, knots, 4);
% figure(); hold on;
% for i = 1:length(B(1,:))
%     plot(xs, B(:, i))
% end

%% 

N = 500;

x = linspace(-30, 30, N);

xs = linspace(-33, 33, 2*N);

y = randn(1, N);

[theta, knots] = smooth_spline(x, y, 0.02, 5, [-33; 33]);

yhat = cox_deBoor(xs, knots{1}, 5)*theta;

figure(); hold on;
scatter(x, y);
plot(xs, yhat)

% B = cox_deBoor(xs, knots, 4);
% figure(); hold on;
% for i = 1:length(B(1,:))
%     plot(xs, B(:, i))
% end

%%

N = 1000;
Ns = 100;

xs = linspace(0, 1, Ns);

y = zeros(N, 1);

y(1) = 0;
y(2) = 0.2;

r = 4;

for i = 3:N
    y(i) = r * y(i-1) * (1 - y(i-1)) + 0.005*randn(1); %  * exp(-0.05*abs(y(i-2)))
    if y(i) < 0 || y(i) > 1
        y(i) = r * y(i-1) * (1 - y(i-1));
    end
end

[theta, knots] = smooth_spline([y(1:end-2),y(2:end-1)] , y(3:end), 0.00002, 4);

yhat = [cox_deBoor(y(1:end-2), knots{1}), cox_deBoor(y(2:end-1), knots{2})]*theta;

resid = y(3:end)-yhat;

MSE = 1/length(yhat)*sum(resid.^2)

% figure(); hold on;
% plot(xs, yhat)
% scatter(y(1:end-1), y(2:end))
% hold off;

[X, Y] = meshgrid(xs, xs);

Yhat = 0.*X;

for i = 1:Ns
    Yhat(:,i) = [cox_deBoor(X(:,i), knots{1}), cox_deBoor(Y(:,i), knots{2})]*theta;
end

figure(); hold on;
scatter3(y(1:end-2), y(2:end-1), y(3:end))
surf(X, Y, Yhat)
xlabel("y(t-2)")
ylabel("y(t-1)")
zlabel("Y(t)")

%% 

N = 2500;
Ns = 100;

xs = linspace(-0.1, 1.1, Ns);

x1 = rand(N, 1); 
x2 = rand(N, 1); 

y = 0.2.*sin(2.*pi.*x1.*x2) + 0.01 .* randn(N, 1); %  4*x1.^2.*(1-x1) + 0.5.*(x2-0.5) +

[theta, knots] = smooth_spline([x1, x2] , y, 0.000002, 4, [-0.1, -0.1; 1.1, 1.1]);

yhat = [cox_deBoor(x1, knots{1}), cox_deBoor(x2, knots{2})] * theta;

resid = y - yhat;
MSE = 1/length(yhat)*sum(resid.^2)

[X, Y] = meshgrid(xs, xs);

Yhat = 0.*X;

for i = 1:Ns
    Yhat(:,i) = [cox_deBoor(X(:,i), knots{1}), cox_deBoor(Y(:,i), knots{2})] * theta;
end

figure(); hold on;
scatter3(x1, x2, y)
surf(X, Y, Yhat)
title('')
xlabel("x")
ylabel("y")
zlabel("z")
